<!DOCTYPE html>
<html lang="en-us">
<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="theme" content="hugo-academic">
  <meta name="generator" content="Hugo 0.32.3" />
  <meta name="author" content="Boyuan Jiang">
  <meta name="description" content="Graduate of Artificial Intelligence">

  
  <link rel="alternate" hreflang="en-us" href="https://byjiang.com/2018/07/25/TimyFlow_3/">

  
  


  

  
  
  
  
    
  
  
    
    
      
        <link rel="stylesheet" href="/libs/highlight.js/9.12.0/styles/github.min.css">
      
    
  
  
  <link rel="stylesheet" href="/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css">
  <link rel="stylesheet" href="/libs/academicons/1.8.6/css/academicons.min.css">
  <link rel="stylesheet" href="/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  
  
  
  
  <link rel="stylesheet" href="//fonts.proxy.ustclug.org/css?family=Montserrat:400,700%7cRoboto:400,400italic,700%7cRoboto&#43;Mono">
  
  <link rel="stylesheet" href="/styles.css">
  

  
    <script>
      window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
      ga('create', 'UA-113237942-1', 'auto');
      ga('require', 'eventTracker');
      ga('require', 'outboundLinkTracker');
      ga('require', 'urlChangeTracker');
      ga('send', 'pageview');
    </script>
    <script async src="//www.google-analytics.com/analytics.js"></script>
    
    <script async src="/libs/autotrack/2.4.1/autotrack.js"></script>
    
  

  
  <link rel="alternate" href="https://byjiang.com/index.xml" type="application/rss+xml" title="进击的加菲猫">
  <link rel="feed" href="https://byjiang.com/index.xml" type="application/rss+xml" title="进击的加菲猫">
  

  <link rel="manifest" href="/site.webmanifest">
  <link rel="icon" type="image/png" href="/img/icon.png">
  <link rel="apple-touch-icon" type="image/png" href="/img/icon-192.png">

  <link rel="canonical" href="https://byjiang.com/2018/07/25/TimyFlow_3/">

  <meta property="twitter:card" content="summary_large_image">
  
  <meta property="og:site_name" content="进击的加菲猫">
  <meta property="og:url" content="https://byjiang.com/2018/07/25/TimyFlow_3/">
  <meta property="og:title" content="TinyFlow阅读(3) | 进击的加菲猫">
  <meta property="og:description" content="">
  <meta property="og:locale" content="en-us">
  
  <meta property="article:published_time" content="2018-07-25T21:56:00&#43;08:00">
  
  <meta property="article:modified_time" content="2018-07-25T21:56:00&#43;08:00">
  

  

  <title>TinyFlow阅读(3) | 进击的加菲猫</title>

</head>
<body id="top" data-spy="scroll" data-target="#toc" data-offset="71" >

<nav class="navbar navbar-default navbar-fixed-top" id="navbar-main">
  <div class="container">

    
    <div class="navbar-header">
      
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
              data-target=".navbar-collapse" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      
      <a class="navbar-brand" href="/">进击的加菲猫</a>
    </div>

    
    <div class="collapse navbar-collapse">

      
      
      <ul class="nav navbar-nav navbar-right">
        

        

        
          
        

        <li class="nav-item">
          <a href="/#about">
            
            <span>Home</span>
            
          </a>
        </li>

        
        

        

        
          
        

        <li class="nav-item">
          <a href="/blog/">
            
            <span>Blog</span>
            
          </a>
        </li>

        
        

        

        
          
        

        <li class="nav-item">
          <a href="/#news">
            
            <span>News</span>
            
          </a>
        </li>

        
        

        

        
          
        

        <li class="nav-item">
          <a href="/#projects">
            
            <span>Projects</span>
            
          </a>
        </li>

        
        

        

        
          
        

        <li class="nav-item">
          <a href="/#publications">
            
            <span>Publications</span>
            
          </a>
        </li>

        
        

        

        
          
        

        <li class="nav-item">
          <a href="/#contact">
            
            <span>Contact</span>
            
          </a>
        </li>

        
        
      

      
      </ul>

    </div>
  </div>
</nav>


<article class="article" itemscope itemtype="http://schema.org/Article">

  


  <div class="article-container">
    <div class="article-inner">
      <h1 itemprop="name">TinyFlow阅读(3)</h1>

      

<div class="article-metadata">

  <span class="article-date">
    
    <time datetime="2018-07-25 21:56:00 &#43;0800 CST" itemprop="datePublished dateModified">
      Jul 25, 2018
    </time>
  </span>
  <span itemscope itemprop="author publisher" itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Boyuan Jiang">
  </span>

  
  <span class="middot-divider"></span>
  <span class="article-reading-time">
    6 min read
  </span>
  

  
  

  
  
  
  

  
  
<div class="share-box" aria-hidden="true">
  <ul class="share">
    <li>
      <a class="twitter"
         href="https://twitter.com/intent/tweet?text=TinyFlow%e9%98%85%e8%af%bb%283%29&amp;url=https%3a%2f%2fbyjiang.com%2f2018%2f07%2f25%2fTimyFlow_3%2f"
         target="_blank" rel="noopener">
        <i class="fa fa-twitter"></i>
      </a>
    </li>
    <li>
      <a class="facebook"
         href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fbyjiang.com%2f2018%2f07%2f25%2fTimyFlow_3%2f"
         target="_blank" rel="noopener">
        <i class="fa fa-facebook"></i>
      </a>
    </li>
    <li>
      <a class="linkedin"
         href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fbyjiang.com%2f2018%2f07%2f25%2fTimyFlow_3%2f&amp;title=TinyFlow%e9%98%85%e8%af%bb%283%29"
         target="_blank" rel="noopener">
        <i class="fa fa-linkedin"></i>
      </a>
    </li>
    <li>
      <a class="weibo"
         href="http://service.weibo.com/share/share.php?url=https%3a%2f%2fbyjiang.com%2f2018%2f07%2f25%2fTimyFlow_3%2f&amp;title=TinyFlow%e9%98%85%e8%af%bb%283%29"
         target="_blank" rel="noopener">
        <i class="fa fa-weibo"></i>
      </a>
    </li>
    <li>
      <a class="email"
         href="mailto:?subject=TinyFlow%e9%98%85%e8%af%bb%283%29&amp;body=https%3a%2f%2fbyjiang.com%2f2018%2f07%2f25%2fTimyFlow_3%2f">
        <i class="fa fa-envelope"></i>
      </a>
    </li>
  </ul>
</div>


  

</div>


      <div class="article-style" itemprop="articleBody">
        <p>这篇文章介绍如何注册用来构建网络所需的符号。
</p>

<p>首先，可以看到在src目录下有<code>op_nn.cc</code>,<code>op_tensor.cc</code>,<code>op_special.cc</code>这三个前端定义op的文件，分别定义了构建网络相关的op（如<code>linear</code>,<code>conv2d</code>等），tensor相关的操作（如<code>ones_like</code>,<code>__add_symbol__</code>等）以及其他的一些操作（主要是<code>_nop</code>,<code>assign</code>和<code>_no_gradient</code>这三个）。而在<code>src/torch</code>目录下，有三个对应的后端定义文件，分别为<code>op_nn_torch.cc</code>,<code>op_tenso_torchr.cc</code>,<code>op_special_torch.cc</code>，在tinyflow中使用torch作为op的后端实现。前端和后端通过nnvm这个框架进行连接。</p>

<p>为了理解前后端的op注册过程，我们首先需要看一下op这个类的定义，其声明代码位于<code>nnvm/include/nnvm/op.h</code>中</p>

<pre><code class="language-C++">class Op {
 public:
  /*! \brief name of the operator */
  std::string name;
  /*!
   * \brief detailed description of the operator
   *  This can be used to generate docstring automatically for the operator.
   */
  std::string description;
  /* \brief description of inputs and keyword arguments*/
  std::vector&lt;ParamFieldInfo&gt; arguments;
  /*!
   * \brief number of inputs to the operator,
   * -1 means it is variable length
   * When get_num_inputs is presented,
   * the number will be decided by get_num_inputs instead.
   * \sa get_num_inputs
   */
  uint32_t num_inputs = 1;
  /*!
   * \brief number of outputs of the operator
   *  When get_num_outputs is presented.
   *  The number of outputs will be decided by
   *  get_num_outputs function
   * \sa get_num_outputs
   */
  uint32_t num_outputs = 1;
  /*!
   * \brief get number of outputs given information about the node.
   * \param attrs The attribute of the node
   * \return number of outputs.
   */
  std::function&lt;uint32_t(const NodeAttrs&amp; attrs)&gt; get_num_outputs = nullptr;
  /*!
   * \brief get number of inputs given information about the node.
   * \param attrs The attribute of the node
   * \return number of inputs
   */
  std::function&lt;uint32_t(const NodeAttrs&amp; attrs)&gt; get_num_inputs = nullptr;
  /*!
   * \brief Attribute parser to parse the NodeAttrs information.
   *
   * This can help to get quick access to a parsed attribute
   * object
   *
   * \code
   *  // Example usage of attr_parser.
   *
   *  // Suppose we want to register operator sum.
   *  // The parameters about sum operator
   *  struct SumParam {
   *    int axis;
   *  };
   *  // The parser function
   *  void SumAttrParser(NodeAttrs* attrs) {
   *     // This will be invoked during node construction.
   *     SumParam param;
   *     // parse axis string to integer
   *     param.axis = atoi(attrs-&gt;dict[&quot;axis&quot;].c_str());
   *     // set the parsed parameter
   *     attrs-&gt;parsed = std::move(param);
   *  }
   *  // The other function that can utilize the parsed result.
   *  TShape SumInferShape(const NodeAttrs&amp; attrs,
   *                       const std::vector&lt;TShape&gt;&amp; ishapes) {
   *     // we can use the parsed version of param
   *     // without repeatively parsing the parameter
   *     const SumParam&amp; param = nnvm::get&lt;SumParam&gt;(attrs.parsed);
   *  }
   * \endcode
   */
  std::function&lt;void(NodeAttrs* attrs)&gt; attr_parser = nullptr;
  // function fields.
  /*!
   * \brief setter function during registration
   *  Set the description of operator
   * \param descr the description string.
   * \return reference to self.
   */
  inline Op&amp; describe(const std::string&amp; descr);  // NOLINT(*)
  /*!
   * \brief Add argument information to the function.
   * \param name Name of the argument.
   * \param type Type of the argument.
   * \param description Description of the argument.
   * \return reference to self.
   */
  inline Op&amp; add_argument(const std::string &amp;name,
                          const std::string &amp;type,
                          const std::string &amp;description);
  /*!
   * \brief Append list if arguments to the end.
   * \param args Additional list of arguments.
   * \return reference to self.
   */
  inline Op&amp; add_arguments(const std::vector&lt;ParamFieldInfo&gt; &amp;args);
  /*!
   * \brief Set the num_inputs
   * \param n The number of inputs to be set.
   * \return reference to self.
   */
  inline Op&amp; set_num_inputs(uint32_t n);  // NOLINT(*)
  /*!
   * \brief Set the get_num_outputs function.
   * \param fn The function to be set.
   * \return reference to self.
   */
  inline Op&amp; set_num_inputs(std::function&lt;uint32_t (const NodeAttrs&amp; attr)&gt; fn);  // NOLINT(*)
  /*!
   * \brief Set the num_outputs
   * \param n The number of outputs to be set.
   * \return reference to self.
   */
  inline Op&amp; set_num_outputs(uint32_t n);  // NOLINT(*)
  /*!
   * \brief Set the get_num_outputs function.
   * \param fn The function to be set.
   * \return reference to self.
   */
  inline Op&amp; set_num_outputs(std::function&lt;uint32_t (const NodeAttrs&amp; attr)&gt; fn);  // NOLINT(*)
  /*!
   * \brief Set the attr_parser function.
   * \param fn The number of outputs to be set.
   * \return reference to self.
   */
  inline Op&amp; set_attr_parser(std::function&lt;void (NodeAttrs* attrs)&gt; fn);  // NOLINT(*)
  /*!
   * \brief Register additional attributes to operator.
   * \param attr_name The name of the attribute.
   * \param value The value to be set.
   * \param plevel The priority level of this set,
   *  an higher priority level attribute
   *  will replace lower priority level attribute.
   *  Must be bigger than 0.
   *
   *  Cannot set with same plevel twice in the code.
   *
   * \tparam ValueType The type of the value to be set.
   */
  template&lt;typename ValueType&gt;
  inline Op&amp; set_attr(const std::string&amp; attr_name,  // NOLINT(*)
                      const ValueType&amp; value,
                      int plevel = 10);
  /*!
   * \brief Add another alias to this operator.
   *   The same Op can be queried with Op::Get(alias)
   * \param alias The alias of the operator.
   * \return reference to self.
   */
  Op&amp; add_alias(const std::string&amp; alias);  // NOLINT(*)
  /*!
   * \brief Include all the attributes from an registered op group.
   * \param group_name The name of the group.
   * \return reference to self.
   *
   * \sa NNVM_REGISTER_OP_GROUP
   */
  Op&amp; include(const std::string&amp; group_name);
  /*!
   * \brief Get an Op for a given operator name.
   *  Will raise an error if the op has not been registered.
   * \param op_name Name of the operator.
   * \return Pointer to a Op, valid throughout program lifetime.
   */
  static const Op* Get(const std::string&amp; op_name);
  /*!
   * \brief Get additional registered attribute about operators.
   *  If nothing has been registered, an empty OpMap will be returned.
   * \param attr_name The name of the attribute.
   * \return An OpMap of specified attr_name.
   * \tparam ValueType The type of the attribute.
   */
  template&lt;typename ValueType&gt;
  static const OpMap&lt;ValueType&gt;&amp; GetAttr(const std::string&amp; attr_name);

 private:
  template&lt;typename ValueType&gt;
  friend class OpMap;
  friend class OpGroup;
  friend class dmlc::Registry&lt;Op&gt;;
  // Program internal unique index of operator.
  // Used to help index the program.
  uint32_t index_{0};
  // internal constructor
  Op();
  // get const reference to certain attribute
  static const any* GetAttrMap(const std::string&amp; key);
  // update the attribute OpMap
  static void UpdateAttrMap(const std::string&amp; key,
                            std::function&lt;void(any*)&gt; updater);
  // add a trigger based on tag matching on certain tag attribute
  // This will apply trigger on all the op such that
  // include the corresponding group.
  // The trigger will also be applied to all future registrations
  // that calls include
  static void AddGroupTrigger(const std::string&amp; group_name,
                              std::function&lt;void(Op*)&gt; trigger);
};
</code></pre>

<p>这里以神经网络中的max_pool层为例，在前端的<code>op_nn.cc</code>中注册如下：</p>

<pre><code class="language-c++">NNVM_REGISTER_OP(max_pool)
.describe(&quot;Max pooling&quot;)
.set_num_inputs(1)
.set_attr_parser(ParamParser&lt;ConvPoolParam&gt;)
.include(&quot;nn_module&quot;)
.set_attr&lt;FInferShape&gt;(&quot;FInferShape&quot;, ConvPoolShape);
</code></pre>

<p><code>NNVM_REGISTER_OP</code>是一个宏定义，即注册一个名为OpName的op，其中#的作用是把OpName转换为一个字符串</p>

<pre><code>#define NNVM_REGISTER_OP(OpName)                                     \
  DMLC_STR_CONCAT(NNVM_REGISTER_VAR_DEF(OpName), __COUNTER__) =         \
      ::dmlc::Registry&lt;::nnvm::Op&gt;::Get()-&gt;__REGISTER_OR_GET__(#OpName)
</code></pre>

<p>结合上面的op类的定义，就可以很容易理解上面的代码完成了以下的工作：</p>

<ul>
<li>定义一个名为max_pool的op</li>
<li>添加这个op功能的描述为&rdquo;Max pooling&rdquo;</li>
<li>这个op接受的输入为一个变量</li>
<li>对输入的参数（如max pool操作的kernel size，stride，padding等参数进行解析）</li>
<li>将op归到nn_module这个op group中</li>
<li>FInferShape，如何通过输入信息推断shape</li>
</ul>

<p>然后，我们再看看在后端这个op是如何实现的，在<code>op_nn_torch.cc</code>中有</p>

<pre><code class="language-c++">NNVM_REGISTER_OP(max_pool)
.set_attr&lt;FLuaCreateNNModule&gt;(
  &quot;FLuaCreateNNModule&quot;, R&quot;(
  function(ishape, kwarg)
    local ksize = nn_parse_tuple(kwarg.ksize)
    local stride = nn_parse_tuple(kwarg.strides, {1,1,1,1})
    local kH = ksize[2]
    local kW = ksize[3]
    local dH = stride[2]
    local dW = stride[3]
    local padH = 0
    local padW = 0
    assert(kwarg.data_format == 'NCHW')
    if kwarg.padding == 'SAME' then
      padW = math.floor((kW - 1) / 2)
      padH = math.floor((kH - 1) / 2)
    end
    return nn.SpatialMaxPooling(kW, kH, dW, dH, padW, padH)
  end
)&quot;);
</code></pre>

<p>其中，*R*的作用是指引号内的字符串不进行任何的转义操作。这里，引号内的字符串其实就是在使用torch实现max pool操作的lua代码，我们之前提到过，tinyflow把torch作为op的后端代理。</p>

<p>至此，在python层面，我们就可以通过以下的方式调用max_pool操作了</p>

<pre><code class="language-python">from nnvm import symbol as _sym
def max_pool(data,
             strides=[1, 1, 1, 1],
             padding='VALID',
             data_format='NCHW', **kwargs):
    return _sym.max_pool(data, strides=strides, padding=padding,
                         data_format=data_format, **kwargs)
</code></pre>
      </div>

      


<div class="article-tags">
  
  <a class="btn btn-primary btn-outline" href="/tags/%e6%ba%90%e7%a0%81%e5%ad%a6%e4%b9%a0">源码学习</a>
  
</div>



    </div>
  </div>

</article>



<div class="article-container article-widget">
  <div class="hr-light"></div>
  <h3>Related</h3>
  <ul>
    
    <li><a href="/2018/07/20/TinyFlow_2/">TinyFlow阅读(2)</a></li>
    
    <li><a href="/2018/07/11/TinyFlow_1/">TinyFlow阅读(1)</a></li>
    
  </ul>
</div>




<div class="article-container">
  

</div>

<footer class="site-footer">
  <div class="container">
    <p class="powered-by">

      &copy; 2017-2019 &middot; 

      Powered by the
      <a href="https://sourcethemes.com/academic/" target="_blank" rel="noopener">Academic theme</a> for
      <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a>.

      <span class="pull-right" aria-hidden="true">
        <a href="#" id="back_to_top">
          <span class="button_icon">
            <i class="fa fa-chevron-up fa-2x"></i>
          </span>
        </a>
      </span>

    </p>
  </div>
</footer>


<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close btn-large" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">Cite</h4>
      </div>
      <div>
        <pre><code class="modal-body tex"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-primary btn-outline js-copy-cite" href="#" target="_blank">
          <i class="fa fa-copy"></i> Copy
        </a>
        <a class="btn btn-primary btn-outline js-download-cite" href="#" target="_blank">
          <i class="fa fa-download"></i> Download
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

    

    
    

    

    
    <script src="/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="/libs/jquery.imagesloaded/4.1.3/imagesloaded.pkgd.min.js"></script>
    <script src="/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="/libs/jquery.isotope/3.0.4/isotope.pkgd.min.js"></script>
    
    
    <script src="/js/hugo-academic.js"></script>
    

    
    
      
      
      
      <script src="/libs/highlight.js/9.12.0/highlight.min.js"></script>
      

      
      <script src="https://byjiang.com/libs/highlight.js/9.12.0/languages/python.min.js"></script>
      

      

      <script>hljs.initHighlightingOnLoad();</script>
    

    
    
    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });
    </script>
    
    <script async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS_CHTML"></script>
    
    

  </body>
</html>

